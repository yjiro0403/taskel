# ルーチン仮想表示方式（Virtual Projection）仕様書

## 1. 概要
本システムでは、ルーチンの将来の予定をデータベース（Firestore）に事前に書き込むのではなく、画面表示時に動的に計算して表示する「仮想表示方式」を採用しています。これにより、無限の未来にわたる予定の把握と、データベースのクリーンな状態を両立させます。

## 2. データ構造の変更
### Routine モデル
- `startDate` (string, YYYY-MM-DD): ルーチンが開始される日。この日付以前には仮想タスクは生成されません。
- `frequency`: `daily`, `weekly`, `monthly`, `custom` に対応。
- `daysOfWeek`: `weekly` の際、どの曜日に出現するかを 0-6 で指定。

### Task モデル
- `routineId` (string, optional): このタスクがどのルーチンから生成（実体化）されたかを示すID。
- `id`: 実体化される際、決定論的ID（後述）を使用します。

## 3. 表示ロジック
### 結合処理 (`getMergedTasks`)
画面に表示するタスクは、以下のステップで生成されます。
1. **実タスクの取得**: 指定された日付（`currentDate`）に紐づく「実体」のタスクをDBから取得。
2. **ルーチン計算**: 全ての有効なルーチンについて、`currentDate` が出現日かどうかを頻度設定から計算。
3. **重複排除**: 出現日であっても、以下のいずれかに該当する場合は仮想タスクを表示しません。
    - DB内に同一の**決定論的ID**を持つ実タスクが既に存在する。
    - `routineId` が一致する実タスクがその日に既に存在する。
4. **マージ**: 実タスクと計算された仮想タスクを統合して表示。

## 4. 実体化（Instantiation）の仕組み
仮想タスクは、ユーザーがアクションを起こした瞬間に「実タスク」としてDBに永続化されます。

### 決定論的ID (Deterministic ID)
仮想タスクおよび実体化後のタスクのIDは、以下の規則で生成されます。
`routine-${routineId}-${dateStr}`
例: `routine-abc-123-2026-01-19`

### 実体化トリガー
以下の操作が行われた際、`updateTask` または `addTask` が呼ばれ、仮想データに基づいた実データがFirestoreに保存されます。
- **再生（Play）ボタンの押下**: ステータスを `in_progress` にして保存。
- **完了（Done）ボタンの押下**: ステータスを `done` にして保存。
- **内容の編集（Edit）**: タイトル、時間、メモなどの変更を保存。

## 5. メリットと制限
### メリット
- **無限の展望**: 1年後や10年後の日付を選択しても、ルーチンが正しく表示される。
- **DB負荷の軽減**: 未来のタスクを事前に何千件も作成する必要がない。
- **個別編集の容易さ**: 特定の日のタスクだけ時間を変えても、他の日のルーチンには影響しない。
- **一括削除の整合性**: ルーチンを削除すれば、全ての未着手の仮想タスクが即座に消える。

### 制限
- 日付を跨いでの表示を行う場合（例: カレンダーのドット表示）、都度計算コストが発生する（現在はクライアントサイドで効率的に処理）。
